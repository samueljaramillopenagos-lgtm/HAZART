<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MQTT - Monitoreo Industrial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 0;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 28px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Panel de Estado */
        .status-panel {
            grid-column: span 2;
        }
        
        @media (max-width: 1024px) {
            .status-panel {
                grid-column: span 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .status-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }
        
        .status-connected { background-color: var(--success-color); }
        .status-disconnected { background-color: var(--danger-color); }
        .status-connecting { background-color: var(--warning-color); }
        
        .connection-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-item {
            flex: 1;
            min-width: 200px;
        }
        
        .info-label {
            font-size: 13px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            word-break: break-all;
        }
        
        /* Controles */
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        select, input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Panel de Mensajes */
        .messages-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
        }
        
        .message-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary-color);
            background-color: #f9f9f9;
        }
        
        .message-topic {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .message-content {
            font-size: 14px;
            color: #555;
        }
        
        /* Logs */
        .logs-container {
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #2d2d2d;
            display: flex;
        }
        
        .log-time {
            color: #6c757d;
            min-width: 85px;
        }
        
        .log-message {
            flex: 1;
            padding-left: 10px;
        }
        
        .log-info { color: #569cd6; }
        .log-success { color: #6a9955; }
        .log-error { color: #f44747; }
        .log-warning { color: #d7ba7d; }
        .log-message-topic { color: #ce9178; }
        
        /* Sensores */
        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .sensor-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .sensor-icon {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .sensor-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .sensor-label {
            font-size: 14px;
            color: var(--gray-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sensor-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .status-normal { background-color: #d4edda; color: #155724; }
        .status-alarm { background-color: #f8d7da; color: #721c24; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Panel de L√≠mites */
        .limits-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
        }
        
        .limits-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .limit-control {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .limit-value {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--gray-color);
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .connection-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .control-group {
                flex-direction: column;
            }
            
            .sensors-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .limits-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-info">
                <div class="logo">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div>
                    <h1>Dashboard MQTT - Monitoreo Industrial</h1>
                    <p class="subtitle">Sistema de monitoreo en tiempo real para sensores industriales</p>
                </div>
            </div>
            <div id="status" class="status-disconnected">
                <span class="status-circle"></span>
                <span>Desconectado</span>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Panel de Estado y Configuraci√≥n -->
            <div class="card status-panel">
                <div class="card-header">
                    <h3><i class="fas fa-cogs"></i> Configuraci√≥n y Estado</h3>
                </div>
                <div class="card-body">
                    <div class="status-indicator">
                        <div>
                            <h4>Conexi√≥n MQTT</h4>
                            <div class="connection-info">
                                <div class="info-item">
                                    <div class="info-label">Broker</div>
                                    <div id="current-broker" class="info-value">No seleccionado</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Client ID</div>
                                    <div id="current-client-id" class="info-value">mqttx_61caf87d</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Estado</div>
                                    <div id="connection-state" class="info-value">Desconectado</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div style="flex: 1;">
                            <div class="info-label">Broker MQTT</div>
                            <select id="brokerSelect" class="full-width">
                                <option value="wss://broker.emqx.io:8084/mqtt">EMQX (WSS) - broker.emqx.io:8084</option>
                                <option value="wss://test.mosquitto.org:8081">Mosquitto (WSS) - test.mosquitto.org:8081</option>
                                <option value="ws://broker.emqx.io:8083/mqtt">EMQX (WS) - broker.emqx.io:8083</option>
                                <option value="ws://test.mosquitto.org:8080">Mosquitto (WS) - test.mosquitto.org:8080</option>
                                <option value="wss://broker.hivemq.com:8884">HiveMQ (WSS) - broker.hivemq.com:8884</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1;">
                            <div class="info-label">Client ID</div>
                            <input type="text" id="clientId" value="mqttx_61caf87d" class="full-width">
                        </div>
                    </div>
                    
                    <div class="control-group" style="margin-top: 20px;">
                        <button onclick="connect()" id="connectBtn" class="btn btn-success">
                            <i class="fas fa-plug"></i> Conectar
                        </button>
                        <button onclick="disconnect()" id="disconnectBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-power-off"></i> Desconectar
                        </button>
                        <button onclick="testPublish()" id="testBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-paper-plane"></i> Publicar Test
                        </button>
                        <button onclick="clearLogs()" class="btn btn-warning">
                            <i class="fas fa-broom"></i> Limpiar Logs
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Panel de Sensores -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-microchip"></i> Sensores Industriales</h3>
                </div>
                <div class="card-body">
                    <div class="sensors-grid">
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="sensor-value" id="temp-value">-- ¬∞C</div>
                            <div class="sensor-label">Temperatura</div>
                            <div class="sensor-status status-normal" id="temp-status">Normal</div>
                        </div>
                        
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-wind"></i>
                            </div>
                            <div class="sensor-value" id="gas-value">-- ppm</div>
                            <div class="sensor-label">Gas</div>
                            <div class="sensor-status status-normal" id="gas-status">Normal</div>
                        </div>
                        
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-power-off"></i>
                            </div>
                            <div class="sensor-value" id="estado-value">--</div>
                            <div class="sensor-label">Estado Sistema</div>
                            <div class="sensor-status status-normal" id="estado-status">Desconocido</div>
                        </div>
                        
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="sensor-value" id="alarma-value">OFF</div>
                            <div class="sensor-label">Alarma</div>
                            <div class="sensor-status status-normal" id="alarma-status">Inactiva</div>
                        </div>
                    </div>
                    
                    <!-- Panel de Configuraci√≥n de L√≠mites -->
                    <div class="limits-panel">
                        <h4><i class="fas fa-sliders-h"></i> Configurar L√≠mites de Alarma</h4>
                        <div class="limits-controls">
                            <div class="limit-control">
                                <div class="info-label">L√≠mite Temperatura (¬∞C)</div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="temp-limit" value="40" min="0" max="100" step="1" style="flex: 1;">
                                    <button onclick="saveLimits()" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                </div>
                                <div style="margin-top: 5px;">
                                    <span class="info-label">Actual: </span>
                                    <span class="limit-value" id="current-temp-limit">40¬∞C</span>
                                </div>
                            </div>
                            
                            <div class="limit-control">
                                <div class="info-label">L√≠mite Gas (ppm)</div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="gas-limit" value="100" min="0" max="500" step="10" style="flex: 1;">
                                    <button onclick="saveLimits()" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                </div>
                                <div style="margin-top: 5px;">
                                    <span class="info-label">Actual: </span>
                                    <span class="limit-value" id="current-gas-limit">100ppm</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Control de Buzzer</h4>
                        <div class="control-group">
                            <button onclick="publishBuzzer('ON')" id="buzzerOnBtn" class="btn btn-success" disabled>
                                <i class="fas fa-volume-up"></i> Encender Buzzer
                            </button>
                            <button onclick="publishBuzzer('OFF')" id="buzzerOffBtn" class="btn btn-danger" disabled>
                                <i class="fas fa-volume-mute"></i> Apagar Buzzer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel de Mensajes -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-comments"></i> Mensajes Recibidos</h3>
                    <span class="badge" id="message-count">0</span>
                </div>
                <div class="card-body">
                    <div class="messages-container" id="messages"></div>
                </div>
            </div>
            
            <!-- Panel de Logs -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-clipboard-list"></i> Logs de Conexi√≥n</h3>
                </div>
                <div class="card-body">
                    <div class="logs-container" id="logs"></div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Pruebas R√°pidas -->
        <div class="card" style="margin-top: 25px;">
            <div class="card-header">
                <h3><i class="fas fa-vial"></i> Pruebas R√°pidas</h3>
            </div>
            <div class="card-body">
                <div class="control-group">
                    <button onclick="testWebSocketDirectly()" class="btn btn-warning">
                        <i class="fas fa-globe"></i> Probar WebSocket Directamente
                    </button>
                    <button onclick="testWithDifferentLibrary()" class="btn btn-warning">
                        <i class="fas fa-exchange-alt"></i> Probar con otra Biblioteca
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Dashboard MQTT - Monitoreo Industrial &copy; 2023 | Conectando dispositivos IoT en tiempo real</p>
        </footer>
    </div>

    <!-- Usaremos la biblioteca MQTT.js que es m√°s moderna y confiable -->
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    
    <script>
        let client = null;
        const logs = [];
        let messageCount = 0;
        
        // Variables para los l√≠mites configurables
        let tempLimit = 40;    // L√≠mite de temperatura en ¬∞C
        let gasLimit = 100;    // L√≠mite de gas en ppm
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = {
                time,
                message,
                type
            };
            logs.push(logEntry);
            
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            let messageClass = 'log-info';
            if (type === 'success') messageClass = 'log-success';
            else if (type === 'error') messageClass = 'log-error';
            else if (type === 'warning') messageClass = 'log-warning';
            else if (type === 'message') messageClass = 'log-message-topic';
            
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-message ${messageClass}">${message}</span>
            `;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(status, message) {
            const statusDiv = document.getElementById('status');
            const statusCircle = statusDiv.querySelector('.status-circle');
            const connectionState = document.getElementById('connection-state');
            
            // Actualizar estado visual
            statusDiv.className = status;
            connectionState.textContent = message;
            
            // Actualizar color del c√≠rculo
            statusCircle.className = 'status-circle';
            if (status === 'connected') {
                statusDiv.innerHTML = '<span class="status-circle status-connected"></span><span>Conectado ‚úì</span>';
                connectionState.textContent = 'Conectado';
                statusCircle.classList.add('status-connected');
            } else if (status === 'disconnected') {
                statusDiv.innerHTML = '<span class="status-circle status-disconnected"></span><span>Desconectado</span>';
                connectionState.textContent = 'Desconectado';
                statusCircle.classList.add('status-disconnected');
            } else if (status === 'connecting') {
                statusDiv.innerHTML = '<span class="status-circle status-connecting"></span><span>Conectando...</span>';
                connectionState.textContent = 'Conectando...';
                statusCircle.classList.add('status-connecting');
            }
            
            // Actualizar broker actual
            const brokerSelect = document.getElementById('brokerSelect');
            const currentBroker = document.getElementById('current-broker');
            currentBroker.textContent = brokerSelect.options[brokerSelect.selectedIndex].text;
            
            // Actualizar client ID actual
            const clientId = document.getElementById('clientId');
            const currentClientId = document.getElementById('current-client-id');
            currentClientId.textContent = clientId.value;
        }
        
        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('testBtn').disabled = !connected;
            document.getElementById('buzzerOnBtn').disabled = !connected;
            document.getElementById('buzzerOffBtn').disabled = !connected;
        }
        
        function saveLimits() {
            // Guardar los nuevos l√≠mites
            tempLimit = parseInt(document.getElementById('temp-limit').value);
            gasLimit = parseInt(document.getElementById('gas-limit').value);
            
            // Actualizar la visualizaci√≥n de l√≠mites actuales
            document.getElementById('current-temp-limit').textContent = tempLimit + '¬∞C';
            document.getElementById('current-gas-limit').textContent = gasLimit + 'ppm';
            
            log(`‚úÖ L√≠mites actualizados: Temperatura=${tempLimit}¬∞C, Gas=${gasLimit}ppm`, 'success');
            
            // Re-evaluar los valores actuales de sensores con los nuevos l√≠mites
            const tempValue = document.getElementById('temp-value').textContent;
            const gasValue = document.getElementById('gas-value').textContent;
            
            // Actualizar estado de temperatura si tiene valor
            if (tempValue !== '-- ¬∞C') {
                const tempNum = parseFloat(tempValue);
                updateSensorStatus('temperature', tempNum);
            }
            
            // Actualizar estado de gas si tiene valor
            if (gasValue !== '-- ppm') {
                const gasNum = parseFloat(gasValue);
                updateSensorStatus('gas', gasNum);
            }
        }
        
        function updateSensorStatus(sensorType, value) {
            if (sensorType === 'temperature') {
                const tempStatus = document.getElementById('temp-status');
                
                if (value > tempLimit) {
                    tempStatus.textContent = 'ALTO >' + tempLimit + '¬∞C';
                    tempStatus.className = 'sensor-status status-alarm';
                    triggerAlarm('Temperatura alta: ' + value + '¬∞C');
                } else if (value < 10) { // L√≠mite inferior fijo
                    tempStatus.textContent = 'BAJO <10¬∞C';
                    tempStatus.className = 'sensor-status status-alarm';
                    triggerAlarm('Temperatura baja: ' + value + '¬∞C');
                } else {
                    tempStatus.textContent = 'Normal';
                    tempStatus.className = 'sensor-status status-normal';
                }
            } 
            else if (sensorType === 'gas') {
                const gasStatus = document.getElementById('gas-status');
                
                if (value > gasLimit) {
                    gasStatus.textContent = 'ALTO >' + gasLimit + 'ppm';
                    gasStatus.className = 'sensor-status status-alarm';
                    triggerAlarm('Gas alto: ' + value + 'ppm');
                } else {
                    gasStatus.textContent = 'Normal';
                    gasStatus.className = 'sensor-status status-normal';
                }
            }
        }
        
        function triggerAlarm(message) {
            // Activar la alarma visual
            document.getElementById('alarma-value').textContent = 'ON';
            document.getElementById('alarma-status').textContent = 'ACTIVA';
            document.getElementById('alarma-status').className = 'sensor-status status-alarm';
            
            // Publicar mensaje de alarma si est√° conectado
            if (client && client.connected) {
                client.publish('industrial/alarma', 'ON', { qos: 0 });
                log(`üö® Alarma activada: ${message}`, 'error');
            }
        }
        
        async function connect() {
            const brokerUrl = document.getElementById('brokerSelect').value;
            const clientId = document.getElementById('clientId').value;
            
            updateStatus('connecting', 'Conectando...');
            log(`Intentando conectar a: ${brokerUrl}`);
            log(`Client ID: ${clientId}`);
            
            try {
                // Usamos MQTT.js que es m√°s confiable que Paho
                const options = {
                    clientId: clientId,
                    clean: true,
                    connectTimeout: 10000,
                    reconnectPeriod: 5000,
                    keepalive: 60
                };
                
                log(`Opci√≥n de conexi√≥n:`, 'info');
                log(`- Client ID: ${options.clientId}`, 'info');
                log(`- Timeout: ${options.connectTimeout}ms`, 'info');
                
                // Intentar conexi√≥n
                client = mqtt.connect(brokerUrl, options);
                
                // Configurar event listeners
                client.on('connect', function () {
                    updateStatus('connected', 'Conectado ‚úì');
                    updateButtons(true);
                    log('‚úÖ CONEXI√ìN EXITOSA AL BROKER', 'success');
                    log(`Protocolo: ${client.options.protocol}`, 'success');
                    log(`Host: ${client.options.hostname}`, 'success');
                    log(`Puerto: ${client.options.port}`, 'success');
                    
                    // Suscribirse a t√≥picos de prueba
                    client.subscribe('test/topic', { qos: 0 }, function (err) {
                        if (!err) {
                            log('‚úÖ Suscrito a: test/topic');
                        }
                    });
                    
                    // Suscribirse a t√≥picos del ESP32
                    const espTopics = [
                        'industrial/temperatura',
                        'industrial/gas',
                        'industrial/estado',
                        'industrial/alarma',
                        'industrial/buzzer/status'
                    ];
                    
                    espTopics.forEach(topic => {
                        client.subscribe(topic, { qos: 0 }, function (err) {
                            if (!err) {
                                log(`‚úÖ Suscrito a: ${topic}`);
                            }
                        });
                    });
                });
                
                client.on('message', function (topic, message) {
                    const msg = message.toString();
                    log(`üì© [${topic}]: ${msg}`, 'message');
                    
                    // Actualizar contador de mensajes
                    messageCount++;
                    document.getElementById('message-count').textContent = messageCount;
                    
                    // Mostrar mensajes en el panel
                    const messagesDiv = document.getElementById('messages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message-item';
                    messageDiv.innerHTML = `
                        <div class="message-topic">${topic}</div>
                        <div class="message-content">${msg}</div>
                    `;
                    messagesDiv.appendChild(messageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                    // Actualizar valores de sensores seg√∫n el t√≥pico
                    updateSensorValues(topic, msg);
                });
                
                client.on('error', function (error) {
                    log(`‚ùå Error: ${error.message}`, 'error');
                    updateStatus('disconnected', 'Error de conexi√≥n');
                    updateButtons(false);
                });
                
                client.on('close', function () {
                    log('üîå Conexi√≥n cerrada', 'warning');
                    updateStatus('disconnected', 'Desconectado');
                    updateButtons(false);
                });
                
                client.on('offline', function () {
                    log('üì¥ Cliente offline', 'warning');
                    updateStatus('disconnected', 'Offline');
                });
                
                client.on('reconnect', function () {
                    log('üîÑ Reconectando...', 'info');
                    updateStatus('connecting', 'Reconectando...');
                });
                
            } catch (error) {
                log(`‚ùå Error al conectar: ${error.message}`, 'error');
                updateStatus('disconnected', 'Error de conexi√≥n');
                updateButtons(false);
            }
        }
        
        function disconnect() {
            if (client && client.connected) {
                client.end();
                client = null;
                updateStatus('disconnected', 'Desconectado manualmente');
                updateButtons(false);
                log('üîå Desconectado manualmente', 'info');
            }
        }
        
        function testPublish() {
            if (client && client.connected) {
                const testMessage = `Mensaje de prueba ${new Date().toLocaleTimeString()}`;
                client.publish('test/topic', testMessage, { qos: 0 }, function (err) {
                    if (!err) {
                        log(`üì§ Publicado en test/topic: ${testMessage}`, 'info');
                    }
                });
                
                // Tambi√©n publicar en t√≥picos del ESP32 para probar
                client.publish('industrial/buzzer/control', 'ON', { qos: 0 });
                log('üì§ Enviado: industrial/buzzer/control = ON', 'info');
            }
        }
        
        function publishBuzzer(state) {
            if (client && client.connected) {
                client.publish('industrial/buzzer/control', state, { qos: 0 });
                log(`üì§ Enviado: industrial/buzzer/control = ${state}`, 'info');
            }
        }
        
        function updateSensorValues(topic, value) {
            // Actualizar los valores de los sensores en el dashboard
            if (topic === 'industrial/temperatura') {
                document.getElementById('temp-value').textContent = `${value} ¬∞C`;
                
                // Cambiar estado seg√∫n el valor y el l√≠mite configurado
                const numValue = parseFloat(value);
                updateSensorStatus('temperature', numValue);
            } 
            else if (topic === 'industrial/gas') {
                document.getElementById('gas-value').textContent = `${value} ppm`;
                
                // Cambiar estado seg√∫n el valor y el l√≠mite configurado
                const numValue = parseFloat(value);
                updateSensorStatus('gas', numValue);
            }
            else if (topic === 'industrial/estado') {
                document.getElementById('estado-value').textContent = value;
                document.getElementById('estado-status').textContent = value;
            }
            else if (topic === 'industrial/alarma') {
                document.getElementById('alarma-value').textContent = value;
                const alarmaStatus = document.getElementById('alarma-status');
                alarmaStatus.textContent = value === 'ON' ? 'ACTIVA' : 'Inactiva';
                alarmaStatus.className = value === 'ON' ? 'sensor-status status-alarm' : 'sensor-status status-normal';
            }
            else if (topic === 'industrial/buzzer/status') {
                // Actualizar estado del buzzer si es necesario
                log(`Buzzer status: ${value}`, 'info');
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('messages').innerHTML = '';
            messageCount = 0;
            document.getElementById('message-count').textContent = '0';
            log('Logs limpiados', 'info');
        }
        
        // Prueba directa de WebSocket
        async function testWebSocketDirectly() {
            const brokerUrl = document.getElementById('brokerSelect').value;
            log(`üîç Probando WebSocket directamente: ${brokerUrl}`, 'info');
            
            try {
                const ws = new WebSocket(brokerUrl);
                
                ws.onopen = function() {
                    log('‚úÖ WebSocket abierto exitosamente', 'success');
                    ws.close();
                };
                
                ws.onerror = function(error) {
                    log(`‚ùå Error en WebSocket: ${error}`, 'error');
                };
                
                ws.onclose = function() {
                    log('üîå WebSocket cerrado', 'info');
                };
                
                // Timeout despu√©s de 5 segundos
                setTimeout(() => {
                    if (ws.readyState !== WebSocket.OPEN) {
                        log('‚è∞ Timeout en prueba WebSocket', 'warning');
                        ws.close();
                    }
                }, 5000);
                
            } catch (error) {
                log(`‚ùå Error al crear WebSocket: ${error.message}`, 'error');
            }
        }
        
        // Probar con otra biblioteca (opci√≥n alternativa)
        async function testWithDifferentLibrary() {
            log('üîÑ Probando con biblioteca alternativa...', 'info');
            
            // Cargar otra biblioteca MQTT
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js';
            script.onload = function() {
                log('‚úÖ Biblioteca MQTT.js cargada', 'success');
                connect(); // Reconectar con la nueva biblioteca
            };
            script.onerror = function() {
                log('‚ùå Error cargando biblioteca', 'error');
            };
            document.head.appendChild(script);
        }
        
        // Inicializaci√≥n
        window.onload = function() {
            log('üîÑ Dashboard MQTT cargado', 'info');
            log('üí° Instrucciones:', 'info');
            log('1. Selecciona un broker de la lista', 'info');
            log('2. Haz clic en "Conectar"', 'info');
            log('3. Monitorea los sensores en tiempo real', 'info');
            log('4. Revisa los logs para ver errores', 'info');
            log('5. Si hay errores, prueba otro broker', 'info');
            log('6. Configura los l√≠mites de temperatura y gas en el panel de sensores', 'info');
            
            // Inicializar valores de sensores
            updateStatus('disconnected', 'Desconectado');
            
            // Mostrar l√≠mites actuales
            document.getElementById('current-temp-limit').textContent = tempLimit + '¬∞C';
            document.getElementById('current-gas-limit').textContent = gasLimit + 'ppm';
            
            // Configurar evento para actualizar broker actual al cambiar selecci√≥n
            document.getElementById('brokerSelect').addEventListener('change', function() {
                const currentBroker = document.getElementById('current-broker');
                currentBroker.textContent = this.options[this.selectedIndex].text;
            });
            
            // Configurar evento para actualizar client ID actual al cambiar
            document.getElementById('clientId').addEventListener('input', function() {
                const currentClientId = document.getElementById('current-client-id');
                currentClientId.textContent = this.value;
            });
            
            // Guardar l√≠mites al presionar Enter en los campos
            document.getElementById('temp-limit').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') saveLimits();
            });
            
            document.getElementById('gas-limit').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') saveLimits();
            });
        };
    </script>
</body>
</html>